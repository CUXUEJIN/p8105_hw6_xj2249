---
title: "p8105_hw6_xj2249"
author: "xj2249"
date: "11/14/2019"
output: github_document
---

```{r setup, include=FALSE}
library(tidyverse)
library(modelr)

knitr::opts_chunk$set(
	echo = TRUE,
	message = FALSE,
	warning = FALSE,
	fig.width = 8, 
	fig.height = 6,
	out.width = "90%"
)

theme_set(theme_minimal() +  theme(plot.title = element_text(hjust = 0.5)) + theme(legend.position = "bottom") + theme(legend.title = element_blank()) )
```

# Problem1
## load and clean the data
```{r}
bw_df <- 
        read_csv("./data/birthweight.csv") %>% 
        janitor::clean_names() %>% 
        mutate(
                babysex = factor(babysex, labels = c("male","female")),
                frace = factor(frace, labels = c("White","Black","Asian","Puerto Rican","Other")),
                malform = factor(malform, labels = c("absent","present")),
                mrace = factor(mrace, labels = c("White","Black", "Asian", "Puerto Rican"))
                )
```

## construct a regression model for birthweight
Describe your modeling process:
As we all know, the sex and the gestational age of the baby will influence the birthweight greatly, so these two will be put into the model definitely. Then, mom's weight gain during pregnancy and pre-pregnancy BMI may also be considered, since 
from whom baby gain all their nutrition. 

now let's fit the model.
```{r}
bw_lm1 <- 
        bw_df %>% 
        lm(bwt~ babysex + gaweeks + ppbmi + wtgain, data = .) 

summary(bw_lm1)

bw_df %>% 
        add_predictions(bw_lm1) %>% 
        add_residuals(bw_lm1) %>% 
        ggplot(aes(x = pred, y = resid)) +
        geom_smooth(se = F,size = 0.5) + 
        geom_point() +
        geom_hline(yintercept = 0,col = "red",linetype = "dashed") + 
        labs( x = "Fitted values", y = "Residuals", title = "Residual vs Fitted Plot")
        geom_hline(aes(yintercept = ))
```

## fit new model with length at birth and gestational age as predictors
```{r}
bw_lm2 <- 
        bw_df %>% 
        lm(bwt~ blength + gaweeks, data = .) 
summary(bw_lm2)


```


## One using head circumference, length, sex, and all interactions (including the three-way interaction) between these
```{r}
bw_lm3 <-
        bw_df %>% 
        lm(bwt~ blength*bhead*babysex, data = .) 
summary(bw_lm3)
```



## cross validation
### generate datasets for training and testing
```{r}
cv_df <- 
        crossv_mc(bw_df,100) %>% 
        mutate(train = map(train,as_tibble),
               test = map(test,as_tibble))

```

### let's fit models and assess predition accuracy
```{r}
cross_result <-
        cv_df %>% 
        mutate( lm1 =  map(.x = train,~lm(bwt~ babysex + gaweeks + ppbmi + wtgain, data = .x)),
                lm2 =  map(.x = train,~lm(bwt~ blength + gaweeks, data = .x)),
                lm3 =  map(.x = train,~lm(bwt~ blength*bhead*babysex, data = .x)),
                rmse_lm1 = map2_dbl(.x = lm1, .y = test, ~rmse(.x,.y)),
                rmse_lm2 = map2_dbl(.x = lm2, .y = test, ~rmse(.x,.y)),
                rmse_lm3 = map2_dbl(.x = lm3, .y = test, ~rmse(.x,.y))
        ) %>% 
        select(starts_with("rmse")) %>% 
        pivot_longer(
                everything(),
                names_to = "model",
                values_to = "rmse",
                names_prefix = "rmse_"
        ) 

cross_result %>%
        mutate(model = factor(model)) %>% 
        ggplot(aes(x = model, y = rmse,fill = model)) +
        geom_violin() +
        labs( title = "Model comparison by RMSE")
```

Unfortunately and sadly, my model looks pretty awful, with the higher RMSEs.
Among three models, the third one is the best, with the lowest RMSEs and the second model is in the middle. 

# 
